---
  - name: Init
    hosts: 
      - web_servers
      - db_servers
    become: yes
    roles:
      - init

  - name: Database server
    hosts: 
      - db_servers
    become: yes
    roles:
      - mysql

  - name: Web server
    hosts: 
      - web_servers
    become: yes
    roles:
      - agama
      - uwsgi
      - nginx

  - name: Setup
    hosts: all
    become: yes
    gather_facts: yes
    tasks:
      - setup:

  - name: Bind setup
    hosts: 
      - dns_servers
    become: yes
    gather_facts: no
    roles:
      - bind
    tasks:
      - debug:
          msg: "{% for vm in groups['all'] %} nameserver {{ hostvars[vm]['ansible_default_ipv4']['address'] }}{% endfor %}"

  - name: DNS server setup
    hosts: all
    become: yes
    roles:
      - dns

  - name: Install Prometheus node exporters
    hosts: all
    become: yes
    roles:
      - node_exporter