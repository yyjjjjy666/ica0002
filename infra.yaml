---
  - name: Collect information about all VMs
    hosts: all
    become: yes
    gather_facts: yes
    tasks:
      - setup:

  - name: Ansible connection test
    hosts: all
    roles:
      - test_connection

  - name: Apt update all VMs
    hosts: all 
    become: yes
    roles:
      - init

  - name: Configure DNS Server
    hosts: 
      - dns_servers
      - bind_exporter
    become: yes
    gather_facts: no
    roles:
      - bind
    tasks:
      - debug:
          msg: "{% for vm in groups['all'] %} nameserver {{ hostvars[vm]['ansible_default_ipv4']['address'] }}{% endfor %}"

  - name: DNS resolver
    hosts: all
    become: yes
    roles:
      - dns_resolve
    
  - name: Install and configure Nginx
    hosts: all
    become: yes
    roles: 
      - nginx
      - nginx_exporter

  - name: Install and configure prometheus
    hosts: 
      - prometheus_server
    become: yes
    roles:
      - prometheus

  - name: Setup DB Server
    hosts: 
      - db_servers
    become: yes
    roles:
      - mysql
      - mysql_exporter

  - name: Setup Web Server
    hosts: 
      - web_servers
    become: yes
    roles:
      - agama
      - uwsgi

  - name: Install Prometheus node exporters
    hosts: all
    become: yes
    roles:
      - node_exporter

  - name: Install and configure Prometheus
    hosts: 
      - prometheus_server
    become: yes
    roles:
      - prometheus

  - name: grafana
    hosts: 
      - grafana
    become: yes
    roles:
      - grafana
    tags:
      - g
